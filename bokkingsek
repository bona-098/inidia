onAppointmentUpdating: async function (e) {
    const appointmentData = e.newData;
    const oldAppointmentData = e.oldData;
    const currentStatus = Number(oldAppointmentData.requestStatus ?? 10);
    
    // Memastikan status valid sebelum melanjutkan
    if (![0, 2, 10].includes(currentStatus)) {          
        DevExpress.ui.notify({
            type: "error",
            displayTime: 3000,
            contentTemplate: (e) => {
                e.append(`
                    <div style="white-space: pre-line;">
                    Action Rejected!\n
                    Tidak diizinkan melakukan perubahan saat ini!\n
                    </div>
                `);
            }
        });
        e.cancel = true;
        return;
    }
    
    // Lanjutkan dengan validasi lainnya dan jangan jalankan Swal.fire jika kondisi status tidak memenuhi
    let selectedRoom = appointmentData.ghm_room_id;
    let bookingData = await loadNewData();
    let roomCapacity = roomsWithLocations.find(room => room.id === selectedRoom)?.roomOccupancy || 0;
    let dailyGuestCount = await getTotalGuestsPerDay(
        bookingData.filter(b => b.requestStatus != 4 && b.requestStatus != 0 && b.requestStatus != 2 && b.requestStatus != 1),
        selectedRoom,
        appointmentData.startDate,
        appointmentData.endDate
    );
    let guestCount = safeArray(appointmentData.guest).length;
    let familyCount = safeArray(appointmentData.family).length;
    let employeeCount = safeArray(appointmentData.employee).length;
    let totalNewGuests = guestCount + familyCount + employeeCount;
    let totalGuestsAfterUpdating = (dailyGuestCount || 0) + totalNewGuests;

    if (totalGuestsAfterUpdating > roomCapacity) {
        Swal.fire({
            title: '<strong>UPS...</strong>',
            html: `
                <div style="white-space: no wrap; overflow: hidden; text-overflow: ellipsis;">
                    The room is full, please select another room or another date!<br>
                    kamar sudah penuh, silahkan pilih kamar lain atau tanggal lain!
                </div>
            `,
            icon: 'error',
            confirmButtonText: 'OK',
        });
        e.cancel = true;
        loadData();
        return;
    }
    
    // Format Date untuk database
    const formatDateForDB = (date) => {
        const d = new Date(date);
        return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}:${d.getSeconds().toString().padStart(2, '0')}`;
    };
    appointmentData.startDate = formatDateForDB(appointmentData.startDate);
    appointmentData.endDate = formatDateForDB(appointmentData.endDate);
    appointmentData.id = e.oldData.id;
    let requestStatus = 0;
    let reqid = appointmentData.id;
    
    // Tampilkan Swal.fire hanya jika update diperbolehkan
    Swal.fire({
        title: 'What do you want to do?',
        text: 'Choose an option for this booking',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Submit Now',
        cancelButtonText: 'Save as Draft',
        reverseButtons: true
    }).then((result) => {
        let requestStatus = 0;
        if (!result.isConfirmed) {
            sendRequest(apiurl + "/"+modname+"/"+reqid, "PUT", {
                requestStatus: requestStatus,
                text: appointmentData.text,
                description: appointmentData.description,
                startDate: appointmentData.startDate,
                endDate: appointmentData.endDate,
                ghm_room_id: appointmentData.ghm_room_id,
                employee: appointmentData.employee,
                guest: appointmentData.guest,
                family: appointmentData.family,
                id: appointmentData.id
            }).then(function () {
                loadData();
            });
        } else {
            sendRequest(apiurl + "/"+modname+"/"+reqid, "PUT", {
                requestStatus: requestStatus,
                text: appointmentData.text,
                description: appointmentData.description,
                startDate: appointmentData.startDate,
                endDate: appointmentData.endDate,
                ghm_room_id: appointmentData.ghm_room_id,
                employee: appointmentData.employee,
                guest: appointmentData.guest,
                family: appointmentData.family,
                id: appointmentData.id
            }).then(function (response) {
                let valapprovalAction = null;
                let actionForm = 'submission';
                let valApprovalType = '';
                let valremarks = '';
                let guestCount = safeArray(appointmentData.guest).length;
                let familyCount = safeArray(appointmentData.family).length;
                
                if (response.status == 'success') {
                    if (familyCount > 0 || guestCount > 0) {
                        sendRequest(apiurl + "/checkattachmentghm", "POST", {
                            req_id: reqid,
                            modelname: modelclass,
                            countfamily: familyCount,
                            countguest: guestCount
                        }).then(function (response) {
                            if (response.status == 'success') {
                                sendRequest(apiurl + "/submissionrequest/" + reqid + "/" + modelclass, "POST", {
                                    requestStatus: 1,
                                    action: actionForm,
                                    approvalAction: (valapprovalAction == null) ? 1 : parseInt(valapprovalAction),
                                    approvalType: valApprovalType,
                                    remarks: valremarks
                                }).then(function (response) {
                                    if (response.status == 'success') {
                                        loadData();
                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Saved',
                                            text: 'The submission has been submitted.',
                                        });
                                    }
                                });
                            }
                        })
                    } else {
                        sendRequest(apiurl + "/submissionrequest/" + reqid + "/" + modelclass, "POST", {
                            requestStatus: 1,
                            action: actionForm,
                            approvalAction: (valapprovalAction == null) ? 1 : parseInt(valapprovalAction),
                            approvalType: valApprovalType,
                            remarks: valremarks
                        }).then(function (response) {
                            if (response.status == 'success') {
                                loadData();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Saved',
                                    text: 'The submission has been submitted.',
                                });
                            }
                        });
                    }
                }
            });
        }
    });
}
