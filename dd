const form = e.form;
const appointmentData = e.appointmentData;
let reqid = appointmentData.id;

console.log("Appointment Data Before:", appointmentData);

if (!reqid) { // Jika tidak ada reqid, lakukan POST untuk membuat data baru
    let cellData = e.cellData || {};
    let ghm_room_id = cellData.ghm_room_id || appointmentData.ghm_room_id;
    let roomData = roomsWithLocations.find(room => room.id === ghm_room_id);
    let sector = roomData ? roomData.sector : null;
    let startDate = cellData.startDate || appointmentData.startDate;
    let endDate = cellData.endDate || appointmentData.endDate;

    if (ghm_room_id && startDate && endDate) { 
        sendRequest(apiurl + "/" + modname, "POST", {
            requestStatus: 0,
            ghm_room_id: ghm_room_id,
            startDate: startDate,
            endDate: endDate,
            sector: sector,
            employee: cellData.employee || appointmentData.employee || [],
            guest: cellData.guest || appointmentData.guest || [],
            family: cellData.family || appointmentData.family || []
        }).then(function(response) {
            console.log("Response from POST request:", response);
            
            if (response.status === 'success') {
                reqid = response.data.id;
                appointmentData.id = reqid; // Update ID baru ke appointmentData

                // **PERUBAHAN PENTING**: Paksa Scheduler untuk menyimpan ID baru
                e.component.updateAppointment(appointmentData, { id: reqid });

                // **PERUBAHAN PENTING**: Paksa form untuk menampilkan data baru
                form.option("formData", appointmentData);
                form.repaint();
            } else {
                DevExpress.ui.notify("Gagal mendapatkan ID!", "error", 3000);
            }
        }).catch(function(error) {
            console.error("Error during POST request:", error);
        });
    } else {
        console.error("Required data is missing");
    }

    dataSubmitted = false;
    if (e.event) { 
        e.event.preventDefault();
    } else {
        console.error("event is undefined");
    }
}

// **DEBUGGING: Cek apakah ID benar-benar diperbarui**
console.log("Updated Appointment Data:", appointmentData);
console.log("Final Req ID:", appointmentData.id);
